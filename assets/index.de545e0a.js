import{i as v}from"./vendor.d8979a21.js";const g=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerpolicy&&(s.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?s.credentials="include":a.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(a){if(a.ep)return;a.ep=!0;const s=e(a);fetch(a.href,s)}};g();Object.prototype.find_deep=function(r){let t=this;return r.split(".").forEach(e=>{t=t?t[e]:void 0}),t};Number.prototype.comma=function(){return this.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};var _={\u5947\u5E7B\u5192\u96AA:"#0388ff",\u6200\u611B:"#ff3f9a",\u5E7D\u9ED8\u641E\u7B11:"#639300",\u9752\u6625\u6821\u5712:"#00ab75",\u79D1\u5E7B\u672A\u4F86:"#00a1bb",\u9748\u7570\u795E\u602A:"#b77a00",\u904B\u52D5\u7AF6\u6280:"#00ac22",\u6599\u7406\u7F8E\u98DF:"#7a72ff",\u5176\u4ED6:"#c55aff",\u6EAB\u99A8:"#ff46d8",\u63A8\u7406\u61F8\u7591:"#00a400",\u793E\u6703\u5BEB\u5BE6:"#f46000",\u6B77\u53F2\u50B3\u8A18:"#ff484f"};class p{constructor(t){this.raw_data=t,this.data=this.raw_data.full,this.types=[...new Set(this.data.map(e=>e.type))],this.types.unshift("All"),this.details_selected=null,this.chart=v(document.querySelector("#chart")),this.sort_selector=document.querySelector("#sort-selector"),this.view_selector=document.querySelector("#view-selector"),this.selector=document.querySelector("#selector"),this.from=document.querySelector("#from_number"),this.to=document.querySelector("#to_number"),this.anime_selector=document.querySelector("#anime-selector"),this.details_chart=v(document.querySelector("#details-chart")),this.create_selector(),this.set_listener(),this.read_search_param(),this.update_chart(),this.set_details_chart(),this.chart.on("click","series",e=>{let i=this.data.filter(a=>this.selector.value==="All"?!0:a.type===this.selector.value)[this.from.value-1+e.dataIndex];this.anime_selector.value=i.name,this.set_details_chart()}),this.details_chart.on("click","series",e=>{this.details_selected=e.name;let i=this.details_chart.getOption();i.series[0].data=i.series[0].data.map((a,s)=>s===e.dataIndex?{value:e.value,symbol:"emptyCircle",symbolSize:9}:typeof a=="number"?a:a.value),this.details_chart.setOption(i)}),document.querySelector("#loading").remove(),location.hash&&document.querySelector(location.hash).scrollIntoView({behavior:"smooth"})}static async create(){let t=await w(),e=t.meta;return console.log(`\u6700\u65B0\u8CC7\u6599\uFF1A${e.latest[0]}/${e.latest[1]}/${e.latest[2]} (${e.latest[3]}:${e.latest[4]}:${e.latest[5]})`),document.querySelector("#extra-info > #update-time").innerHTML+=`${e.latest[0]}/${e.latest[1]}/${e.latest[2]} (${e.latest[3]}:${e.latest[4]}:${e.latest[5]})`,new p(t)}view(){if(this.view_selector.value==="auto")switch(this.sort_mode){case"\u96C6\u5747\u89C0\u770B\u6578":return"view_avg";case"\u7E3D\u89C0\u770B\u6578":return"view";case"\u8A55\u5206":return"vote.score";case"\u4F5C\u54C1\u5E74\u4EFD":return"year"}else return this.view_selector.value}sort_data(t="view_avg"){switch(t){case"view_avg":this.data.sort((e,i)=>i.view_avg-e.view_avg),this.sort_mode="\u96C6\u5747\u89C0\u770B\u6578",this.sort="view_avg";break;case"view":this.data.sort((e,i)=>i.view-e.view),this.sort_mode="\u7E3D\u89C0\u770B\u6578",this.sort="view";break;case"score":this.data.sort((e,i)=>i.vote.score-e.vote.score||i.vote.voter-e.vote.voter),this.sort_mode="\u8A55\u5206",this.sort="vote.score";break;case"year":this.data.sort((e,i)=>i.year-e.year||i.month-e.month),this.sort_mode="\u4F5C\u54C1\u5E74\u4EFD",this.sort="year";break}}set_chart({type:t,data:e}){console.log(`\u985E\u5225\uFF1A${t} - \u7E3D\u5171\u6709 ${e.length} \u7B46\u8CC7\u6599`);let i={title:{text:t},grid:{containLabel:!0},tooltip:{formatter:a=>{let s=a.dataIndex,n=e[s].name,h=this.raw_data.full.filter(u=>u.name===n)[0],l='<span class="tnum">';return l=`<b>${e[s].name}</b> (<b>${e[s].year}/${e[s].month}</b>)<br>`,l+=`<span class="inline-block w-24">\u96C6\u5747\u89C0\u770B\u6578\uFF1A</span><span class="inline-block w-20 text-right"><b>${parseInt(e[s].view_avg.toFixed(0)).comma()}</b></span><br>`,l+=`<span class="inline-block w-24">\u7E3D\u89C0\u770B\u6578\uFF1A</span><span class="inline-block w-20 text-right"><b>${e[s].view.comma()}</b></span><br>`,l+=`<span class="inline-block w-24">\u8A55\u5206\uFF1A</span><span class="inline-block w-20 text-right"><b>${h.vote.score}</b> (<b>${h.vote.voter.comma()}</b>)</span><br>`,l+="</span>",l}},legend:{data:[...new Set(e.map(a=>a.type))]},xAxis:{data:e.map(a=>+a.find_deep(this.sort).toFixed(1))},yAxis:{},series:[{name:this.sort_mode,type:"bar",data:e.map(a=>({value:a.find_deep(this.view()).toFixed(1),itemStyle:{color:_[a.type]}}))}]};this.chart.setOption(i)}create_selector(){this.types.forEach(t=>{let e=document.createElement("option");e.innerHTML=e.value=t,this.selector.appendChild(e)}),this.data.map(t=>t.name).sort((t,e)=>t>e?1:-1).forEach(t=>{let e=document.createElement("option");e.value=t,document.querySelector("#anime-list").appendChild(e)}),this.anime_selector.value=this.data[0].name}set_listener(){this.sort_selector.addEventListener("change",t=>{this.update_chart()}),this.view_selector.addEventListener("change",t=>{this.update_chart()}),this.selector.addEventListener("change",t=>{this.update_chart()}),this.from.addEventListener("change",t=>{this.update_chart()}),this.to.addEventListener("change",t=>{this.update_chart()}),this.anime_selector.addEventListener("change",t=>{this.set_details_chart(this.anime_selector.value)}),window.addEventListener("resize",t=>{this.chart.resize(),this.details_chart.resize()})}update_chart(){y({sort:this.sort_selector.value,view:this.view_selector.value,type:this.selector.value,from:this.from.value,to:this.to.value,anime:this.anime_selector.value}),this.sort_data(this.sort_selector.value),this.selector.value==="All"?this.set_chart({type:"All",data:this.data.slice(this.from.value-1,this.to.value)}):this.set_chart({type:this.selector.value,data:this.data.filter(t=>t.type===this.selector.value).slice(this.from.value-1,this.to.value)})}read_search_param(){let t=new URLSearchParams(location.search);t.has("sort")&&(this.sort_selector.value=t.get("sort")),t.has("view")&&(this.view_selector.value=t.get("view")),t.has("type")&&(this.selector.value=t.get("type")),t.has("from")&&(this.from.value=t.get("from")),t.has("to")&&(this.to.value=t.get("to")),t.has("anime")&&(this.anime_selector.value=t.get("anime")),t.has("ppc")&&b(t.get("ppc"))}set_details_chart(){let t=this.anime_selector.value,e=this.raw_data.full.filter(o=>o.name===t)[0];if(!e)return null;this.details_selected=null,y({sort:this.sort_selector.value,view:this.view_selector.value,type:this.selector.value,from:this.from.value,to:this.to.value,anime:this.anime_selector.value});let i=Object.entries(e.details).sort((o,c)=>parseFloat(o[0])<parseFloat(c[0])?-1:o[0]<c[0]?1:0),a={title:{text:e.name,link:`https://ani.gamer.com.tw/animeRef.php?sn=${e.sn}`},grid:{containLabel:!0},tooltip:{trigger:"axis",formatter:o=>{let c=`<b>${o[0].axisValue}</b><br>\u89C0\u770B\u6578\uFF1A <b>${o[0].value.comma()}</b>`;if(this.details_selected){let d=o[0].value-e.details[this.details_selected],f=+(d*100/e.details[this.details_selected]).toFixed(1);c+=`<br>\u8207\u7B2C ${this.details_selected} \u96C6\u6BD4\u8F03\uFF1A${d>0?"+":""}${d.comma()} (${f>0?"+":""}${f}%)`}return c}},legend:{data:i.map(o=>o[1])},xAxis:{data:i.map(o=>o[0])},yAxis:{type:"value"},series:[{data:i.map(o=>o[1]),type:"line",symbol:"circle",symbolSize:6}],color:_[e.type]};this.details_chart.setOption(a);let s=Object.values(e.details),n=Number.MIN_SAFE_INTEGER,h=0,l=Number.MAX_SAFE_INTEGER,u=0;s.forEach((o,c)=>{o>n?(n=o,h=Object.keys(e.details)[c]):o<l&&(l=o,u=Object.keys(e.details)[c])});let m=`\u300C<a class="text-purple-600" href="https://ani.gamer.com.tw/animeRef.php?sn=${e.sn}" target="_blank">${e.name}</a>\u300D\u9019\u90E8 ${+e.year} \u5E74 ${+e.month} \u6708\u63A8\u51FA\u7684\u4F5C\u54C1\u5728\u5DF4\u54C8\u59C6\u7279\u52D5\u756B\u760B${s.length>1?"\u7B2C\u4E00\u96C6":""}\u7684\u89C0\u770B\u6578\u9054\u5230 ${s[0].comma()} \u4EBA\u6B21\u3002`;if(s.length>1){m+=`\u8A72\u4F5C\u54C1\u64C1\u6709\u6700\u9AD8\u89C0\u770B\u6578\u7684${h==="1"?"\u5C31":""}\u662F\u7B2C ${h} \u96C6\uFF0C\u89C0\u770B\u6578\u70BA ${n.comma()} \u4EBA\u6B21\uFF0C\u800C\u5176\u64C1\u6709\u6700\u4F4E\u89C0\u770B\u6578\u7684\u5247\u662F\u7B2C ${u} \u96C6\uFF0C\u89C0\u770B\u6578\u70BA ${l.comma()} \u4EBA\u6B21\u3002`;let o=s[0]>s[s.length-1];m+=`\u5176\u6700\u5F8C\u4E00\u96C6\u8F03\u7B2C\u4E00\u96C6\u7684\u89C0\u770B\u6578${o?"\u6E1B\u5C11":"\u589E\u52A0"}\u4E86 ${Math.abs(s[0]-s[s.length-1]).comma()} \u4EBA\u6B21\uFF0C\u63DB\u53E5\u8A71\u8AAA\uFF0C\u76F8\u8F03\u65BC\u7B2C\u4E00\u96C6${o?"\u4E0B\u964D":"\u589E\u52A0"}\u4E86 ${(o?(s[0]-s[s.length-1])*100/s[0]:(s[s.length-1]-s[0])*100/s[0]).toFixed(0)}%\u3002`,o&&(s[s.length-1]-l)/(n-l)>.5&&(m+=`\u503C\u5F97\u4E00\u63D0\u7684\u662F\uFF0C\u6700\u5F8C\u4E00\u96C6\u7684\u89C0\u770B\u6578\u76F8\u8F03\u65BC\u7B2C ${u} \u96C6\uFF08\u4E5F\u5C31\u662F\u6700\u5C11\u89C0\u770B\u6578\u7684\u90A3\u96C6\uFF09\u589E\u52A0\u4E86 ${((s[s.length-1]-l)*100/l).toFixed(0)}% \uFF0C\u6216\u8A31\u53EF\u4EE5\u8AAA\u662F\u6551\u56DE\u4F86\u4E86\u4E00\u4E9B\u3002`)}m+="<br><br>",e.vote.score&&(m+=`\u9019\u90E8\u4F5C\u54C1\u5728 ${e.vote.voter.comma()} \u500B\u89C0\u773E\u8A55\u50F9\u4E2D\uFF0C\u7372\u5F97${e.vote.score>4.7?"\u9AD8\u9054":""} ${e.vote.score} \u5206\u7684\u8A55\u50F9\uFF0C\u4EE5\u767E\u5206\u5236\u8868\u793A\u5247\u70BA ${e.vote.percentage} \u5206\u3002`),document.querySelector("#more-anime-data").innerHTML=m}}function y(r){let t=new URLSearchParams;Object.entries(r).forEach(e=>{t.append(...e)}),history.pushState(r,"","?"+t.toString())}async function b(r){await new Promise(t=>setTimeout(t,100)),r=r.replace(/\n/g,";"),r=r.split(";"),r=r.map(t=>t.trim()),r=r.filter(t=>t!=="");for(let t=0;t<r.length;t++){const e=r[t];try{await new Promise(s=>setTimeout(s,20));const[i,a]=e.split(" ");i==="sort"?document.querySelector("#sort-selector").value=a:i==="view"?document.querySelector("#view-selector").value=a:i==="type"?document.querySelector("#selector").value=a:i==="from"?document.querySelector("#from_number").value=a:i==="to"&&(document.querySelector("#to_number").value=a),(await window.show).update_chart()}catch(i){console.error("\u7121\u6CD5\u89E3\u6790\u9810\u8655\u7406\u6307\u4EE4",i)}}}async function w(){let r=await fetch("https://raw.githubusercontent.com/JacobLinCool/Bahamut-Anime-Analytics/data/meta.json").then(a=>a.json()),t=await fetch(`https://cdn.jsdelivr.net/gh/JacobLinCool/Bahamut-Anime-Analytics@data/${r.latest[0]}/${r.latest[1]}/${r.latest[2]}/Full/all.json`).then(a=>a.json()),e=await fetch(`https://cdn.jsdelivr.net/gh/JacobLinCool/Bahamut-Anime-Analytics@data/${r.latest[0]}/${r.latest[1]}/${r.latest[2]}/Monthly/all.json`).then(a=>a.json()),i={};return t.forEach(a=>{i[a.name]=Object.assign(i[a.name]||{name:a.name,ep:a.ep,image:a.image,year:a.year,month:a.month,sn:a.sn,type:a.type,vote:a.vote},{full:a})}),e.forEach(a=>{i[a.name]=Object.assign(i[a.name]||{name:a.name,ep:a.ep,image:a.image,year:a.year,month:a.month,sn:a.sn,type:a.type},{monthly:a})}),{meta:r,full:t,monthly:e,merged:Object.values(i),anime:i}}window.show=p.create();
